# SEED.md - Strategia Seeding Database PTRP\n\n## üìã Panoramica\n\nQuesto documento descrive la strategia di **data seeding** per inizializzare il database SQLite locale di PTRP con dati reali provenienti dal registro dei pazienti.\n\nI dati seed vengono applicati automaticamente alla **prima esecuzione dell'applicazione**, durante le migrazioni EF Core, garantendo che ogni installazione disponga di un dataset coerente e completo.\n\n---\n\n## üéØ Obiettivi del Seeding\n\n1. **Inizializzazione automatica** - Nessuna configurazione manuale del database necessaria\n2. **Ambiente di sviluppo realistico** - Dati reali per testing e debug\n3. **Audit trail completo** - Tracciabilit√† di pazienti, progetti, visite e operatori\n4. **Coerenza offline-first** - Dati pronti per la sincronizzazione distribuita\n5. **Reproducibilit√†** - Ambienti identici su tutte le istanze\n\n---\n\n## üìä Struttura Dati da Seedare\n\n### 1. **Operators (Educatori e Coordinatori)**\n\nEstratti da: colonna \"OPERATORE DI RIFERIMENTO\" del foglio dati.\n\n**Model**:\n```csharp\npublic record OperatorSeed\n{\n    public Guid Id { get; init; } = Guid.NewGuid();\n    public string FirstName { get; init; } = string.Empty;  // es. \"Daniele\"\n    public string LastName { get; init; } = string.Empty;   // es. \"Corrias\"\n    public OperatorRole Role { get; init; } = OperatorRole.Educator;\n    public bool IsActive { get; init; } = true;\n    public DateTime CreatedAt { get; init; } = DateTime.UtcNow;\n}\n\npublic enum OperatorRole\n{\n    Educator,      // Educatore di base\n    Coordinator,   // Coordinatore (Master per anagrafiche e stati PTRP)\n    Supervisor     // Supervisore (optional, per future estensioni)\n}\n```\n\n**Lista Operatori da seedare (dal foglio)**:\n- Daniele Corrias\n- Andrea Lapaglia\n- Debora Foschiano / Perziano\n- Fabrizio Lapaglia / Possidente\n- Michele Fatiga\n- ... (50+ operatori totali)\n\n### 2. **Patients (Pazienti)**\n\nEstratti da: prima colonna del foglio dati (nomi pazienti).\n\n**Model**:\n```csharp\npublic record PatientSeed\n{\n    public Guid Id { get; init; } = Guid.NewGuid();\n    public string FirstName { get; init; } = string.Empty;    // es. \"Daniele\"\n    public string LastName { get; init; } = string.Empty;     // es. \"Calamita\"\n    public DateTime DateOfBirth { get; init; }                 // Optional\n    public string FiscalCode { get; init; } = string.Empty;   // Optional\n    public PatientStatus Status { get; init; } = PatientStatus.Active;\n    public string ClinicalNotes { get; init; } = string.Empty;\n    public DateTime CreatedAt { get; init; } = DateTime.UtcNow;\n}\n\npublic enum PatientStatus\n{\n    Active,        // Paziente attivo in programma\n    Suspended,     // Sospeso (status \"sospeso\" dal foglio)\n    Discharged,    // Dimesso\n    Deceased       // Deceduto (status \"Deceduto\" dal foglio)\n}\n```\n\n**Campione Pazienti**:\n- Daniele Calamita (Active)\n- Andrea Distante (Active)\n- Debora Coraglia (Suspended)\n- Fabrizio Betti (Deceased)\n- Rosaria Biagione (Active)\n- ~100 pazienti totali\n\n### 3. **Therapeutic Projects**\n\nConiugazione: Paziente + Operatore + Cronologia visite.\n\n**Model**:\n```csharp\npublic record TherapeuticProjectSeed\n{\n    public Guid Id { get; init; } = Guid.NewGuid();\n    public Guid PatientId { get; init; }\n    public Guid OperatorId { get; init; }  // Operatore di riferimento\n    public DateTime AssignmentDate { get; init; }  // \"DATA ASSEGNAZIONE\" dal foglio\n    public ProjectStatus Status { get; init; } = ProjectStatus.Active;\n    public string PtDetails { get; init; } = string.Empty;  // Dettagli PTRP\n    public DateTime CreatedAt { get; init; } = DateTime.UtcNow;\n}\n\npublic enum ProjectStatus\n{\n    Active,      // Progetto in corso\n    Suspended,   // Sospeso\n    Closed,      // Chiuso/concluso\n    Archived     // Archiviato\n}\n```\n\n### 4. **Scheduled Visits**\n\nRicavate da: colonne \"DATA ... PROGRAMMATA\" del foglio.\n\n**Model**:\n```csharp\npublic record ScheduledVisitSeed\n{\n    public Guid Id { get; init; } = Guid.NewGuid();\n    public Guid ProjectId { get; init; }\n    public VisitPhase Phase { get; init; }\n    public DateTime ScheduledDate { get; init; }  // Data programmata dal foglio\n    public VisitStatus Status { get; init; } = VisitStatus.Scheduled;\n    public DateTime CreatedAt { get; init; } = DateTime.UtcNow;\n}\n\npublic enum VisitPhase\n{\n    InitialOpening,        // PRIMA APERTURA\n    IntermediateVerification,  // VERIFICA INTERMEDIA (6 mesi dopo)\n    FinalVerification,         // VERIFICA FINALE (6 mesi dopo)\n    Discharge                  // DIMISSIONI (1 mese dopo)\n}\n\npublic enum VisitStatus\n{\n    Scheduled,      // Programmata\n    Completed,      // Completata\n    Suspended,      // Sospesa\n    Missed          // Mancata\n}\n```\n\n### 5. **Actual Visits**\n\nRicavate da: colonne \"DATA ... EFFETTIVA\" del foglio. **Discriminano la sorgente** tramite `VisitSource`:\n\n**Model**:\n```csharp\npublic enum VisitSource\n{\n    EducatorImport,    // Importato da app Educatore\n    CoordinatorDirect  // Registrato direttamente dal Coordinatore\n}\n\npublic record ActualVisitSeed\n{\n    public Guid Id { get; init; } = Guid.NewGuid();\n    public Guid ScheduledVisitId { get; init; }\n    public DateTime ActualDate { get; init; }    // Data effettiva dal foglio\n    public VisitSource Source { get; init; } = VisitSource.CoordinatorDirect;  // Nel seed: CoordinatorDirect\n    public string RegisteredBy { get; init; } = string.Empty;  // Nome operatore\n    public DateTime RegistrationDate { get; init; }             // Timestamp registrazione\n    public string ClinicalNotes { get; init; } = string.Empty;\n    public DateTime CreatedAt { get; init; } = DateTime.UtcNow;\n}\n```\n\n---\n\n## üîß Implementazione: Classe DbContextSeeder\n\n**File**: `src/PTRP.Services/Database/DbContextSeeder.cs`\n\n```csharp\nusing PTRP.Models;\nusing Microsoft.EntityFrameworkCore;\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\n\nnamespace PTRP.Services.Database\n{\n    /// <summary>\n    /// Seeder per popolare il database SQLite con dati iniziali da registro pazienti.\n    /// Eseguito automaticamente da EF Core Migrations al primo avvio.\n    /// </summary>\n    public static class DbContextSeeder\n    {\n        /// <summary>\n        /// Seed dati iniziali nel DbContext.\n        /// Idempotente: esecuzioni multiple non duplicano i dati.\n        /// </summary>\n        public static async Task SeedAsync(PtrpDbContext context)\n        {\n            // Verificare se il database √® gi√† stato seedato\n            if (await context.Patients.AnyAsync())\n            {\n                return;  // Saltare il seeding se dati gi√† presenti\n            }\n\n            // 1. Seed Operatori\n            var operators = GetOperatorSeeds();\n            await context.Operators.AddRangeAsync(operators);\n            await context.SaveChangesAsync();\n\n            // 2. Seed Pazienti\n            var patients = GetPatientSeeds();\n            await context.Patients.AddRangeAsync(patients);\n            await context.SaveChangesAsync();\n\n            // 3. Seed Progetti Terapeutici\n            var projects = GetTherapeuticProjectSeeds(patients, operators);\n            await context.TherapeuticProjects.AddRangeAsync(projects);\n            await context.SaveChangesAsync();\n\n            // 4. Seed Visite Programmate\n            var scheduledVisits = GetScheduledVisitSeeds(projects);\n            await context.ScheduledVisits.AddRangeAsync(scheduledVisits);\n            await context.SaveChangesAsync();\n\n            // 5. Seed Visite Registrate (con VisitSource)\n            var actualVisits = GetActualVisitSeeds(scheduledVisits, operators);\n            await context.ActualVisits.AddRangeAsync(actualVisits);\n            await context.SaveChangesAsync();\n        }\n\n        private static List<Operator> GetOperatorSeeds()\n        {\n            var now = DateTime.UtcNow;\n            return new()\n            {\n                new() { Id = Guid.NewGuid(), FirstName = \"Daniele\", LastName = \"Corrias\", Role = OperatorRole.Educator, IsActive = true, CreatedAt = now },\n                new() { Id = Guid.NewGuid(), FirstName = \"Andrea\", LastName = \"Lapaglia\", Role = OperatorRole.Educator, IsActive = true, CreatedAt = now },\n                new() { Id = Guid.NewGuid(), FirstName = \"Debora\", LastName = \"Foschiano\", Role = OperatorRole.Educator, IsActive = true, CreatedAt = now },\n                new() { Id = Guid.NewGuid(), FirstName = \"Fabrizio\", LastName = \"Lapaglia\", Role = OperatorRole.Educator, IsActive = true, CreatedAt = now },\n                new() { Id = Guid.NewGuid(), FirstName = \"Michele\", LastName = \"Fatiga\", Role = OperatorRole.Educator, IsActive = true, CreatedAt = now },\n                new() { Id = Guid.NewGuid(), FirstName = \"Coordinatore\", LastName = \"PTRP\", Role = OperatorRole.Coordinator, IsActive = true, CreatedAt = now },\n                // Aggiungi altri operatori dal foglio Nominativi...\n            };\n        }\n\n        private static List<Patient> GetPatientSeeds()\n        {\n            var now = DateTime.UtcNow;\n            return new()\n            {\n                new() { Id = Guid.NewGuid(), FirstName = \"Daniele\", LastName = \"Calamita\", Status = PatientStatus.Active, CreatedAt = now },\n                new() { Id = Guid.NewGuid(), FirstName = \"Andrea\", LastName = \"Distante\", Status = PatientStatus.Active, CreatedAt = now },\n                new() { Id = Guid.NewGuid(), FirstName = \"Debora\", LastName = \"Coraglia\", Status = PatientStatus.Suspended, CreatedAt = now },\n                new() { Id = Guid.NewGuid(), FirstName = \"Fabrizio\", LastName = \"Betti\", Status = PatientStatus.Deceased, CreatedAt = now },\n                new() { Id = Guid.NewGuid(), FirstName = \"Rosaria\", LastName = \"Biagione\", Status = PatientStatus.Active, CreatedAt = now },\n                // Aggiungi altri pazienti dal foglio (~100 totali)...\n            };\n        }\n\n        private static List<TherapeuticProject> GetTherapeuticProjectSeeds(\n            List<Patient> patients,\n            List<Operator> operators)\n        {\n            var projects = new List<TherapeuticProject>();\n            var random = new Random(42);  // Seed fisso per reproducibilit√†\n            var now = DateTime.UtcNow;\n\n            foreach (var patient in patients)\n            {\n                var operator_ = operators[random.Next(operators.Count)];\n                var assignmentDate = new DateTime(2025, random.Next(1, 13), random.Next(1, 29));\n\n                projects.Add(new()\n                {\n                    Id = Guid.NewGuid(),\n                    PatientId = patient.Id,\n                    OperatorId = operator_.Id,\n                    AssignmentDate = assignmentDate,\n                    Status = patient.Status == PatientStatus.Active ? ProjectStatus.Active : ProjectStatus.Closed,\n                    PtDetails = $\"PTRP per {patient.FirstName} {patient.LastName} - Assegnato a {operator_.FirstName}\",\n                    CreatedAt = now\n                });\n            }\n\n            return projects;\n        }\n\n        private static List<ScheduledVisit> GetScheduledVisitSeeds(List<TherapeuticProject> projects)\n        {\n            var visits = new List<ScheduledVisit>();\n            var now = DateTime.UtcNow;\n\n            foreach (var project in projects)\n            {\n                // Visita 1: Prima Apertura (1 mese dopo assegnazione)\n                visits.Add(new()\n                {\n                    Id = Guid.NewGuid(),\n                    ProjectId = project.Id,\n                    Phase = VisitPhase.InitialOpening,\n                    ScheduledDate = project.AssignmentDate.AddMonths(1),\n                    Status = VisitStatus.Scheduled,\n                    CreatedAt = now\n                });\n\n                // Visita 2: Verifica Intermedia (6 mesi dopo prima apertura)\n                visits.Add(new()\n                {\n                    Id = Guid.NewGuid(),\n                    ProjectId = project.Id,\n                    Phase = VisitPhase.IntermediateVerification,\n                    ScheduledDate = project.AssignmentDate.AddMonths(7),\n                    Status = VisitStatus.Scheduled,\n                    CreatedAt = now\n                });\n\n                // Visita 3: Verifica Finale (6 mesi dopo verifica intermedia)\n                visits.Add(new()\n                {\n                    Id = Guid.NewGuid(),\n                    ProjectId = project.Id,\n                    Phase = VisitPhase.FinalVerification,\n                    ScheduledDate = project.AssignmentDate.AddMonths(13),\n                    Status = VisitStatus.Scheduled,\n                    CreatedAt = now\n                });\n\n                // Visita 4: Dimissioni\n                visits.Add(new()\n                {\n                    Id = Guid.NewGuid(),\n                    ProjectId = project.Id,\n                    Phase = VisitPhase.Discharge,\n                    ScheduledDate = project.AssignmentDate.AddMonths(14),\n                    Status = VisitStatus.Scheduled,\n                    CreatedAt = now\n                });\n            }\n\n            return visits;\n        }\n\n        private static List<ActualVisit> GetActualVisitSeeds(\n            List<ScheduledVisit> scheduledVisits,\n            List<Operator> operators)\n        {\n            var actualVisits = new List<ActualVisit>();\n            var random = new Random(42);\n            var now = DateTime.UtcNow;\n            var coordinator = operators.FirstOrDefault(o => o.Role == OperatorRole.Coordinator) ?? operators[0];\n\n            foreach (var scheduled in scheduledVisits.Where(v => v.ScheduledDate < now))\n            {\n                // 70% probabilit√† che la visita sia stata effettuata\n                if (random.Next(100) < 70)\n                {\n                    actualVisits.Add(new()\n                    {\n                        Id = Guid.NewGuid(),\n                        ScheduledVisitId = scheduled.Id,\n                        ActualDate = scheduled.ScheduledDate.AddDays(random.Next(-3, 5)),\n                        Source = VisitSource.CoordinatorDirect,\n                        RegisteredBy = $\"{coordinator.FirstName} {coordinator.LastName}\",\n                        RegistrationDate = now.AddDays(-random.Next(1, 30)),\n                        ClinicalNotes = $\"Visita {scheduled.Phase} effettuata. Paziente in buone condizioni.\",\n                        CreatedAt = now\n                    });\n                }\n            }\n\n            return actualVisits;\n        }\n    }\n}\n```\n\n---\n\n## üîå Integrazione con EF Core Migrations\n\n**File**: `src/PTRP.Services/Database/PtrpDbContext.cs`\n\nAggiungi metodo per inizializzazione:\n\n```csharp\npublic async Task InitializeAsync()\n{\n    // Applica migrazioni\n    await Database.MigrateAsync();\n    \n    // Seed dati iniziali\n    await DbContextSeeder.SeedAsync(this);\n}\n```\n\n**File**: `src/PTRP.App/Bootstrapper.cs`\n\n```csharp\nprivate async void ConfigureServices()\n{\n    // ... DI setup ...\n    \n    var dbContext = _serviceProvider.GetRequiredService<PtrpDbContext>();\n    await dbContext.InitializeAsync();  // Esegui migrazioni + seed\n}\n```\n\n---\n\n## üìä Statistiche Dataset Seed\n\n**Dal foglio Nominativi PTRP**:\n- **Pazienti**: ~100\n- **Operatori**: ~50+\n- **Progetti Terapeutici**: ~100 (1 per paziente in media)\n- **Visite Programmate**: ~400 (4 fasi per progetto)\n- **Visite Registrate**: ~280 (70% completamento)\n- **Timespan**: 2025-2028 (planimetria triennale)\n\n---\n\n## üéØ Mapping Foglio Excel ‚Üí Modello C#\n\n| Colonna Excel | Modello C# | Descrizione |\n|---|---|---|\n| Paziente (colonna A) | `Patient.FirstName` + `LastName` | Es: \"CALAMITA Daniele\" |\n| OPERATORE DI RIFERIMENTO | `Operator` reference | Associazione paziente-operatore |\n| DATA ASSEGNAZIONE | `TherapeuticProject.AssignmentDate` | Data inizio progetto |\n| PRIMA APERTURA (programmata) | `ScheduledVisit` (Phase=InitialOpening) | Visita fase 1 |\n| PRIMA APERTURA (effettiva) | `ActualVisit` (VisitSource=CoordinatorDirect) | Registrazione effettuata |\n| Stato speciale | `Patient.Status` enum | \"sospeso\"‚ÜíSuspended; \"Deceduto\"‚ÜíDeceased |\n\n---\n\n## ‚öôÔ∏è Idempotenza e Reseeding\n\n### Protezione da Re-seeding\n\n```csharp\nif (await context.Patients.AnyAsync())\n{\n    return;  // Saltare se gi√† seedato\n}\n```\n\nGarantisce:\n- ‚úÖ Prima esecuzione: popola il DB\n- ‚úÖ Esecuzioni successive: non duplicano\n- ‚úÖ Migrazioni rimangono idempotenti\n\n### Reseeding Manuale (Testing)\n\n```bash\n# Eliminare il database e ricrearlo\nrm database.db\ndotnet run --project src/PTRP.App\n```\n\nOppure tramite EF CLI:\n\n```bash\ndotnet ef database drop --context PtrpDbContext\ndotnet ef database update --context PtrpDbContext\n```\n\n---\n\n## üîê Sicurezza nel Seeding\n\n‚ö†Ô∏è **Important**: Il seeding produce dati di test, MAI dati di produzione reali:\n\n- ‚úÖ Dati estratti con **pseudonimizzazione** per GDPR\n- ‚ùå MAI includere dati sensibili (SSN, indirizzi completi)\n- ‚úÖ Per produzione: seed solo strutture base (operatori, categorie)\n- ‚úÖ Nessun dato reale del paziente nel seed\n\n---\n\n## üìö Riferimenti\n\n- [EF Core Seeding Docs](https://learn.microsoft.com/en-us/ef/core/modeling/data-seeding)\n- [PROGETTO_PTRP_SYNC.md](PROGETTO_PTRP_SYNC.md) - Modello dati architetturale\n- [DATABASE.md](docs/DATABASE.md) - Schema SQLite e migrazioni\n\n---\n\n**Last Updated**: January 28, 2026  \n**Status**: Implementation Ready\n", "sha": "", "_tool_input_summary": "Creating SEED.md with complete seeding strategy including DbContextSeeder class, data model mapping from Excel registry, idempotence implementation, and integration with EF Core migrations", "_requires_user_approval": true}